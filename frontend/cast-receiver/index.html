<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MegaRadio Cast Receiver</title>
    
    <!-- Google Cast Receiver SDK -->
    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Ubuntu', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(180deg, #0D0D0D 0%, #1A0A12 50%, #2D0D1A 100%);
            color: #FFFFFF;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* Animated background circles (like splash screen) */
        .bg-circles {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 600px;
            height: 600px;
            pointer-events: none;
        }

        .circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            border: 1px solid rgba(255, 65, 153, 0.1);
            animation: pulse 4s ease-in-out infinite;
        }

        .circle:nth-child(1) { width: 200px; height: 200px; animation-delay: 0s; }
        .circle:nth-child(2) { width: 300px; height: 300px; animation-delay: 0.5s; }
        .circle:nth-child(3) { width: 400px; height: 400px; animation-delay: 1s; }
        .circle:nth-child(4) { width: 500px; height: 500px; animation-delay: 1.5s; }
        .circle:nth-child(5) { width: 600px; height: 600px; animation-delay: 2s; }

        @keyframes pulse {
            0%, 100% { opacity: 0.3; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 0.6; transform: translate(-50%, -50%) scale(1.05); }
        }

        /* Pink dots decoration */
        .dots {
            position: absolute;
            bottom: 40px;
            left: 40px;
            display: grid;
            grid-template-columns: repeat(5, 8px);
            gap: 8px;
        }

        .dot {
            width: 8px;
            height: 8px;
            background: #FF4199;
            border-radius: 50%;
            opacity: 0.6;
        }

        /* Main content */
        .container {
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 40px;
        }

        /* Logo */
        .logo-container {
            margin-bottom: 40px;
        }

        .logo {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #FF4199 0%, #FF6B6B 100%);
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            font-weight: bold;
            color: white;
            box-shadow: 0 20px 60px rgba(255, 65, 153, 0.4);
        }

        .brand-name {
            font-size: 32px;
            font-weight: 700;
            margin-top: 20px;
            letter-spacing: 2px;
        }

        /* Album art */
        .album-art-container {
            position: relative;
            margin-bottom: 40px;
        }

        .album-art {
            width: 280px;
            height: 280px;
            border-radius: 20px;
            background: linear-gradient(135deg, #1E1E1E 0%, #2A2A2A 100%);
            object-fit: cover;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.5);
        }

        .album-art.playing {
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { box-shadow: 0 30px 80px rgba(255, 65, 153, 0.3); }
            to { box-shadow: 0 30px 100px rgba(255, 65, 153, 0.5); }
        }

        /* Equalizer animation */
        .equalizer {
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 4px;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
        }

        .eq-bar {
            width: 4px;
            height: 20px;
            background: #FF4199;
            border-radius: 2px;
            animation: eq 0.8s ease-in-out infinite;
        }

        .eq-bar:nth-child(1) { animation-delay: 0.0s; }
        .eq-bar:nth-child(2) { animation-delay: 0.1s; }
        .eq-bar:nth-child(3) { animation-delay: 0.2s; }
        .eq-bar:nth-child(4) { animation-delay: 0.3s; }
        .eq-bar:nth-child(5) { animation-delay: 0.4s; }

        @keyframes eq {
            0%, 100% { height: 8px; }
            50% { height: 24px; }
        }

        .equalizer.paused .eq-bar {
            animation: none;
            height: 8px;
        }

        /* Station info */
        .station-info {
            margin-bottom: 20px;
        }

        .station-name {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 10px;
            max-width: 600px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .now-playing {
            font-size: 24px;
            color: rgba(255, 255, 255, 0.7);
            max-width: 600px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .now-playing.animated {
            animation: scroll 10s linear infinite;
        }

        @keyframes scroll {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        /* Status */
        .status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 24px;
            background: rgba(255, 65, 153, 0.2);
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            color: #FF4199;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background: #FF4199;
            border-radius: 50%;
            animation: blink 1.5s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        .status.paused {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
        }

        .status.paused .status-dot {
            background: rgba(255, 255, 255, 0.6);
            animation: none;
        }

        /* Idle state */
        .idle-screen {
            display: none;
        }

        body.idle .container {
            display: none;
        }

        body.idle .idle-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            position: relative;
        }

        .idle-logo {
            width: 200px;
            height: 200px;
            background: linear-gradient(135deg, #FF4199 0%, #FF6B6B 100%);
            border-radius: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 100px;
            font-weight: bold;
            color: white;
            margin-bottom: 30px;
            box-shadow: 0 30px 80px rgba(255, 65, 153, 0.4);
        }

        .idle-text {
            font-size: 28px;
            color: rgba(255, 255, 255, 0.7);
        }

        .idle-brand {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 20px;
            letter-spacing: 3px;
        }

        /* Error state */
        .error-message {
            display: none;
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 107, 107, 0.2);
            color: #FF6B6B;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            z-index: 100;
        }

        body.error .error-message {
            display: block;
        }
    </style>
</head>
<body class="idle">
    <!-- Background decorations -->
    <div class="bg-circles">
        <div class="circle"></div>
        <div class="circle"></div>
        <div class="circle"></div>
        <div class="circle"></div>
        <div class="circle"></div>
    </div>

    <div class="dots">
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
        <div class="dot"></div>
    </div>

    <!-- Idle screen (when no media is playing) -->
    <div class="idle-screen">
        <div class="idle-logo">M</div>
        <div class="idle-brand">MEGARADIO</div>
        <div class="idle-text">Cast yaparak radyo dinlemeye başlayın</div>
    </div>

    <!-- Main player content -->
    <div class="container">
        <div class="album-art-container">
            <img id="albumArt" class="album-art" src="" alt="Album Art">
            <div id="equalizer" class="equalizer">
                <div class="eq-bar"></div>
                <div class="eq-bar"></div>
                <div class="eq-bar"></div>
                <div class="eq-bar"></div>
                <div class="eq-bar"></div>
            </div>
        </div>

        <div class="station-info">
            <div id="stationName" class="station-name">Loading...</div>
            <div id="nowPlaying" class="now-playing"></div>
        </div>

        <div id="status" class="status">
            <div class="status-dot"></div>
            <span id="statusText">CANLI YAYIN</span>
        </div>
    </div>

    <!-- Error message -->
    <div class="error-message" id="errorMessage">
        Bağlantı hatası. Lütfen tekrar deneyin.
    </div>

    <script>
        // MegaRadio Custom Cast Receiver
        const context = cast.framework.CastReceiverContext.getInstance();
        const playerManager = context.getPlayerManager();

        // DOM Elements
        const body = document.body;
        const albumArt = document.getElementById('albumArt');
        const stationName = document.getElementById('stationName');
        const nowPlaying = document.getElementById('nowPlaying');
        const status = document.getElementById('status');
        const statusText = document.getElementById('statusText');
        const equalizer = document.getElementById('equalizer');
        const errorMessage = document.getElementById('errorMessage');

        // Default album art
        const DEFAULT_ALBUM_ART = 'data:image/svg+xml,' + encodeURIComponent(`
            <svg width="280" height="280" viewBox="0 0 280 280" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect width="280" height="280" rx="20" fill="url(#gradient)"/>
                <text x="140" y="160" font-family="Ubuntu, sans-serif" font-size="120" font-weight="bold" fill="white" text-anchor="middle">M</text>
                <defs>
                    <linearGradient id="gradient" x1="0" y1="0" x2="280" y2="280">
                        <stop offset="0%" stop-color="#FF4199"/>
                        <stop offset="100%" stop-color="#FF6B6B"/>
                    </linearGradient>
                </defs>
            </svg>
        `);

        // Update UI based on player state
        function updateUI(playerState) {
            console.log('[MegaRadio Receiver] Player state:', playerState);

            switch (playerState) {
                case cast.framework.messages.PlayerState.IDLE:
                    body.classList.add('idle');
                    body.classList.remove('error');
                    break;

                case cast.framework.messages.PlayerState.BUFFERING:
                    body.classList.remove('idle', 'error');
                    statusText.textContent = 'YÜKLENİYOR...';
                    equalizer.classList.add('paused');
                    break;

                case cast.framework.messages.PlayerState.PLAYING:
                    body.classList.remove('idle', 'error');
                    statusText.textContent = 'CANLI YAYIN';
                    status.classList.remove('paused');
                    equalizer.classList.remove('paused');
                    albumArt.classList.add('playing');
                    break;

                case cast.framework.messages.PlayerState.PAUSED:
                    body.classList.remove('idle', 'error');
                    statusText.textContent = 'DURAKLATILDI';
                    status.classList.add('paused');
                    equalizer.classList.add('paused');
                    albumArt.classList.remove('playing');
                    break;
            }
        }

        // Update media info
        function updateMediaInfo(mediaInfo) {
            console.log('[MegaRadio Receiver] Media info:', mediaInfo);

            if (!mediaInfo) {
                albumArt.src = DEFAULT_ALBUM_ART;
                stationName.textContent = 'MegaRadio';
                nowPlaying.textContent = '';
                return;
            }

            const metadata = mediaInfo.metadata || {};
            
            // Station name
            stationName.textContent = metadata.title || 'MegaRadio';
            
            // Now playing (artist/subtitle)
            const artist = metadata.artist || metadata.subtitle || '';
            nowPlaying.textContent = artist;
            
            // Album art
            if (metadata.images && metadata.images.length > 0) {
                const imageUrl = metadata.images[0].url;
                albumArt.src = imageUrl;
                albumArt.onerror = () => {
                    albumArt.src = DEFAULT_ALBUM_ART;
                };
            } else {
                albumArt.src = DEFAULT_ALBUM_ART;
            }
        }

        // Player state change listener
        playerManager.addEventListener(
            cast.framework.events.EventType.PLAYER_STATE_CHANGED,
            (event) => {
                updateUI(event.state);
            }
        );

        // Media info changed listener
        playerManager.addEventListener(
            cast.framework.events.EventType.MEDIA_INFORMATION_CHANGED,
            (event) => {
                const mediaInfo = playerManager.getMediaInformation();
                updateMediaInfo(mediaInfo);
            }
        );

        // Error handler
        playerManager.addEventListener(
            cast.framework.events.EventType.ERROR,
            (event) => {
                console.error('[MegaRadio Receiver] Error:', event);
                body.classList.add('error');
                
                let errorText = 'Bağlantı hatası. Lütfen tekrar deneyin.';
                if (event.detailedErrorCode) {
                    switch (event.detailedErrorCode) {
                        case cast.framework.events.DetailedErrorCode.MEDIA_UNKNOWN:
                            errorText = 'Medya formatı desteklenmiyor.';
                            break;
                        case cast.framework.events.DetailedErrorCode.MEDIA_DECODE:
                            errorText = 'Medya decode edilemiyor.';
                            break;
                        case cast.framework.events.DetailedErrorCode.MEDIA_SRC_NOT_SUPPORTED:
                            errorText = 'Stream formatı desteklenmiyor.';
                            break;
                        default:
                            errorText = 'Bir hata oluştu. Kod: ' + event.detailedErrorCode;
                    }
                }
                errorMessage.textContent = errorText;
                
                // Clear error after 5 seconds
                setTimeout(() => {
                    body.classList.remove('error');
                }, 5000);
            }
        );

        // Intercept LOAD request to handle various stream formats
        playerManager.setMessageInterceptor(
            cast.framework.messages.MessageType.LOAD,
            (request) => {
                console.log('[MegaRadio Receiver] Load request:', request);
                
                const mediaInfo = request.media;
                
                // Handle content type for radio streams
                if (mediaInfo && mediaInfo.contentUrl) {
                    const url = mediaInfo.contentUrl.toLowerCase();
                    
                    // Auto-detect content type if not specified or generic
                    if (!mediaInfo.contentType || mediaInfo.contentType === 'audio/mpeg') {
                        if (url.includes('.m3u8') || url.includes('hls')) {
                            mediaInfo.contentType = 'application/x-mpegURL';
                        } else if (url.includes('.aac')) {
                            mediaInfo.contentType = 'audio/aac';
                        } else if (url.includes('.ogg')) {
                            mediaInfo.contentType = 'audio/ogg';
                        }
                    }
                    
                    // Set stream type to LIVE for radio
                    mediaInfo.streamType = cast.framework.messages.StreamType.LIVE;
                    
                    console.log('[MegaRadio Receiver] Processed media info:', mediaInfo);
                }
                
                return request;
            }
        );

        // Configure playback
        const playbackConfig = new cast.framework.PlaybackConfig();
        playbackConfig.autoResumeDuration = 5; // Resume after 5 seconds of buffering
        playbackConfig.initialBandwidthEstimate = 2000000; // 2 Mbps initial estimate
        
        // Supported media commands
        playerManager.setSupportedMediaCommands(
            cast.framework.messages.Command.PAUSE |
            cast.framework.messages.Command.SEEK |
            cast.framework.messages.Command.STREAM_VOLUME |
            cast.framework.messages.Command.STREAM_MUTE
        );

        // Start the receiver
        const options = new cast.framework.CastReceiverOptions();
        options.disableIdleTimeout = true; // Keep receiver alive
        options.playbackConfig = playbackConfig;
        
        context.start(options);
        
        console.log('[MegaRadio Receiver] Started successfully');
    </script>
</body>
</html>
