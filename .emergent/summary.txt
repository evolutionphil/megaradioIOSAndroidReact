<analysis>**original_problem_statement:**
The user wants to build a production-ready mobile radio streaming app called MegaRadio.

**PRODUCT REQUIREMENTS:**
-   **Tech Stack:** Expo, TypeScript, EAS Build, Expo Router, Zustand, React Query, Axios, .
-   **Core Features:** Robust audio streaming with proper background/lock screen controls, Favorites, Recently Played, Profile.
-   **Authentication:** All API requests must include . Google and Apple social logins were also requested.
-   **Build & Deployment:** The user wants to build the application for iOS and Android and submit it to the respective app stores.
-   **Platform Expansion:** The user has requested support for CarPlay, Android Auto, Apple Watch, Wear OS, tvOS, and Android TV.

**User's preferred language**: Turkish

**what currently exists?**
The project is an Expo (React Native) application. The initial critical blocker (iOS black screen) is resolved, and the app is now launchable. This session focused on fixing numerous crashes, UI bugs, and feature regressions reported by the user after the app became launchable.

Major fixes include resolving crashes on the Genre Detail and All Stations pages, fixing the player screen, standardizing all fonts to Ubuntu, correcting MiniPlayer positioning, ensuring authentication persists between sessions, and adding a fallback for user avatars. The iOS lock screen controls and favorites loading mechanism were recurring problems that were debugged extensively. CarPlay has been identified as a feature that requires migrating the project from Expo's managed workflow to the bare workflow and is currently disabled to prevent crashes.

**Last working item**:
-   **Last item agent was working**: The agent was addressing three critical, recurring issues reported by the user in the latest TestFlight build:
    1.  **Avatar Fallback:** A broken avatar URL resulted in a blank space. The agent created a new  component to handle image loading errors.
    2.  **iOS Lock Screen Controls:** The next/previous station buttons were inactive. The agent identified that the main  was missing the required , , , and  capabilities and added them.
    3.  **Favorites Loading:** Only 4 favorites were loading instead of 40+. The agent identified this as a race condition where data fetching was attempted before the auth token was loaded from storage. A fix was started but was blocked.
-   **Status**: IN PROGRESS
-   **Agent Testing Done**: N
-   **Which testing method agent to use?**: Manual testing by the user via a new EAS build.
-   **User Testing Done**: Y (The user tested the previous build and reported these three issues are still present).

**All Pending/In progress Issue list**:
-   Issue 1: Favorites only loading 4 items instead of 40 (P0 - CRITICAL)
-   Issue 2: iOS Lock Screen next/previous controls are not active (P0 - CRITICAL)
-   Issue 3: Avatar fallback is not working for invalid URLs (P0 - CRITICAL)
-   Issue 4: watchOS build fails in Xcode (P0)
-   Issue 5: Google OAuth still fails on Android (P0 - Blocked)
-   Issue 6: Test recent major implementations (Tablet UI, Casting) (P1)
-   Issue 7: Fix Sleep Timer (P2)

**Issues Detail:**
-   **Issue 1: Favorites only loading 4 items instead of 40 (P0)**
    -   **Description**: After a fresh login, the favorites tab shows a small number of items (likely from local storage) instead of the full list from the server. This is a race condition.
    -   **Attempted fixes**: The root cause was identified:  is called before the async  completes, resulting in a token-less API request. The agent started to implement a fix by adding an  flag to the .
    -   **Next debug checklist**:
        1.  Resolve the Metro bundler cache issue (see Blocked on other issue below).
        2.  Complete the implementation of the  flag in .
        3.  Update  to use a  hook that waits for  to become  before calling .
    -   **Why fix this issue and what will be achieved with the fix?**: This is a core feature regression. Users are not seeing their full list of saved favorite stations.
    -   **Status**: BLOCKED
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: Frontend
    -   **Blocked on other issue**: A persistent Metro bundler cache issue prevents the import of newly created components, blocking further code changes.

-   **Issue 2: iOS Lock Screen next/previous controls are not active (P0)**
    -   **Description**: On the iOS lock screen and Control Center, the buttons to skip to the next or previous station are not visible or are disabled.
    -   **Attempted fixes**: The root cause was identified: The main  was not setting all the necessary capabilities for the track player. The agent added , , , and  to the  call.
    -   **Next debug checklist**:
        1.  Create a new EAS build for the user.
        2.  Verify on a device that after playing a station, the lock screen controls for jumping forward/backward are visible and functional.
    -   **Why fix this issue and what will be achieved with the fix?**: Essential for a radio app, allowing users to control playback without unlocking their phone.
    -   **Status**: USER VERIFICATION PENDING
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: Frontend

-   **Issue 3: Avatar fallback is not working for invalid URLs (P0)**
    -   **Description**: If a user's avatar URL is invalid or missing, a blank space is shown instead of a placeholder icon.
    -   **Attempted fixes**: The agent created a new reusable component, , which internally handles image loading errors and displays a styled fallback icon. This component was integrated into the Discovery and Profile pages.
    -   **Next debug checklist**:
        1.  Resolve the Metro bundler cache issue.
        2.  Create a new EAS build.
        3.  Verify that for a user with no avatar, a styled placeholder icon appears on the Discovery and Profile screens.
    -   **Why fix this issue and what will be achieved with the fix?**: Fixes a broken UI element and improves visual polish.
    -   **Status**: BLOCKED
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: Frontend
    -   **Blocked on other issue**: The same Metro bundler cache issue blocking the Favorites fix.

-   **Issue 4: watchOS build fails in Xcode (P0)**
    -   **Description**: The user is unable to successfully build the watchOS target in their local Xcode environment.
    -   **Attempted fixes**: The agent refactored and cleaned up all necessary watchOS files into a self-contained directory: .
    -   **Next debug checklist**: Guide the user to create a brand new watchOS target in Xcode, delete the template files, and copy in the prepared files.
    -   **Why fix this issue and what will be achieved with the fix?**: Unblocks development of the Apple Watch companion app.
    -   **Status**: USER VERIFICATION PENDING
    -   **Is recurring issue?**: Y
    -   **Should Test frontend/backend/both after fix?**: Frontend

**In progress Task List**:
-   **Task 1: Resolve Metro Bundler Cache Issue**
    -   **Where to resume**: Metro bundler is unable to resolve the import for the newly created  file, despite multiple attempts to clear cache and restart. This is blocking all further development.
    -   **What will be achieved with this?**: This will unblock the fixes for the Avatar Fallback and Favorites Loading issues.
    -   **Status**: IN PROGRESS
    -   **Blocked on something**: This is a tooling/environment issue. The next agent should attempt more aggressive cache clearing () or investigate Metro configuration.

**Upcoming and Future Tasks**
**Upcoming Tasks:**
-   **P0**: Migrate to Expo Bare Workflow to enable CarPlay. The user has been briefed on the process and its implications. This is a major architectural task.
-   **P1**: Re-implement Splash Screen (Awaiting new design).
-   **P1**: Resolve App Store Rejection (Follow up on content rights issue).

**Future Tasks:**
-   **P2**: Implement UI animations (e.g., Static Equalizer on player screen).
-   **P2**: Add support for tvOS & Android TV.

**Completed work in this session**
-   **Resolved Critical App Launch Failure**: Fixed the iOS Black Screen issue, making the app launchable.
-   **Fixed Multiple Crashes**: Resolved crashes on the Genre Detail () and All Stations () pages caused by syntax errors.
-   **Fixed Player Screen Crash**: Corrected an  variable error in .
-   **Fixed Authentication Persistence**: Ensured users remain logged in between sessions by calling  on app startup in .
-   **Standardized Font System**: Refactored the entire application to use the Ubuntu font family, removing all instances of  and inline  styles.
-   **Created Nearby Stations Page**: Implemented a new See All screen for nearby stations at .
-   **Improved UI/UX**:
    -   Modernized the TV Cast popup () with an Apple-style bottom sheet design.
    -   Enhanced the Player screen () by increasing the logo's glow effect and adding deep-linking to YouTube and Spotify for the current song.
    -   Corrected MiniPlayer positioning on non-tab screens.
    -   Fixed text alignment and styles in the Discoverable Genres section.
    -   Added dynamic bottom padding to the Discovery screen scroll view to avoid overlapping the MiniPlayer.
-   **Refined Sorting**: Removed Newest and Oldest sort options from station lists as requested.

**Earlier issues found/mentioned but not fixed**
-   The Metro bundler cache issue was a major un-fixed problem that emerged during the session and blocked other fixes.

**Code Architecture**


**Key Technical Concepts**
-   **React Native State Management**: Using Zustand for global state (, , ).
-   **Expo Workflows**: The app is on the managed workflow. The limitation of this workflow is blocking CarPlay functionality, which requires a migration to the bare workflow to access native iOS code.
-   ****: Deep debugging of iOS lock screen controls, understanding the difference between  and  capabilities, and the necessity of setting capabilities in both the background service and foreground provider.
-   **Async Race Conditions**: Diagnosing the issue where data fetching () occurs before authentication is loaded (), leading to failed API calls.
-   **Expo/Metro Tooling**: Encountered a persistent Metro bundler cache issue that prevented the resolution of new module imports, blocking development.

**key DB schema**
-   No database changes were made in this session.

**All files of reference**
-   : Contains the logic for fetching and storing favorite stations. Key file for the 4 vs 40 bug.
-   : Manages user authentication state and token persistence.
-   : Manages foreground track player state. Key file for the lock screen controls bug.
-   : The background service for .
-   : Root layout, where authentication is loaded on startup.
-   : Discovery page, where the avatar fallback is implemented.
-   : Profile page, also uses the avatar fallback.
-   : The new component created to solve the avatar issue, but currently causing a Metro cache problem.

**key api endpoints**
-   : Used for user login, returns a JWT.
-   : Fetches the user's favorite stations. The root of the 4 vs 40 bug was related to calling this endpoint without a valid token.

**Critical Info for New Agent**
-   **İLETİŞİMİ TÜRKÇE SÜRDÜRÜN (COMMUNICATE IN TURKISH).**
-   **The TOP PRIORITY is to resolve the Metro bundler cache issue.** It is preventing the import of the new  component and is blocking fixes for the Avatar and Favorites bugs. Try aggressive cache clearing: .
-   Once unblocked, proceed to fix the three critical recurring issues: **Favorites loading**, **Lock Screen controls**, and **Avatar fallback**. The root causes and planned fixes are detailed in the Issues Detail section.
-   **CarPlay is INTENTIONALLY DISABLED** in  to prevent a native crash. Do not re-enable it. The user has been informed that a migration to the **Expo bare workflow** is necessary for CarPlay to function. This should be treated as a separate, significant future task.
-   The user is understandably frustrated with the recurring nature of some bugs. Be methodical, explain the root causes that were found, and confirm each fix with a new build.

**Last 10 User Messages and any pending HUMAN messages**
-   **User:** Stations near you see all button should open a new screen sorted by distance. (Status: COMPLETED,  was created).
-   **User:** Discovery page see more button scrolls too high. (Status: COMPLETED, dynamic padding was added).
-   **User:** Avatar is not showing on Discovery or Profile pages; a fallback icon should be used. (Status: IN PROGRESS, fix is blocked by Metro cache issue).
-   **User:** I'm not staying logged in when I close and reopen the app. (Status: COMPLETED,  was added to ).
-   **User:** My favorites are not syncing correctly from the web (shows 4 instead of 40). (Status: IN PROGRESS, root cause identified, fix is blocked by Metro cache issue).
-   **User:** Discoverable genres text style is wrong (alignment, font). (Status: COMPLETED).
-   **User:** I want all italic fonts removed and everything to use Ubuntu. (Status: COMPLETED, a large font refactor was done).
-   **User:** After a new build, avatar, lock screen controls, and favorites are STILL broken. (Status: ADDRESSED, this triggered the final debug session where root causes were found).
-   **User:** Player screen logo glow is too faint, YouTube/Spotify links should work, and the TV popup looks bad. (Status: COMPLETED).
-   **User:** Did you investigate the favorites issue again? What was the reason? (Status: PENDING, the final explanation and fix are still in progress).

**Project Health Check:**
-   **Broken**:
    -   Favorites loading is unreliable due to a race condition.
    -   Avatar display is broken for users without a valid avatar URL.
    -   iOS lock screen controls are not functioning.
-   **Mocked**:
    -   CarPlay functionality is disabled to prevent crashing.

**3rd Party Integrations**
-   : Core audio streaming.
-   : Installed but disabled.
-   : Installed for casting functionality.
-   : Used for Google Sign-In.
-   EAS (Expo Application Services): Used for building the application.

**Testing status**
-   **Testing agent used after significant changes**: YES, a  was used at the end to help identify the root causes of the three most critical bugs.
-   **Test files created**: None.
-   **Known regressions**: Avatar fallback, lock screen controls, and favorites loading have been persistent, recurring issues that have regressed despite multiple fix attempts. The latest fixes are believed to be correct but are pending verification.

**Credentials to test flow:**
-   **API Key**: 
-   **Test Account**:  /  (This account has 40+ favorites on the web, useful for testing the favorites bug).</analysis>
